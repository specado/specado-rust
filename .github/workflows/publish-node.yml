name: Publish Node.js Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_npm:
        description: 'Publish to Test npm registry instead of npm'
        required: false
        default: false
        type: boolean

jobs:
  build-native:
    name: Build native modules on ${{ matrix.os }} for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - os: macos-latest
            target: x86_64-apple-darwin
            build-name: darwin-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            build-name: darwin-arm64
          
          # Linux builds
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            build-name: linux-x64-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            build-name: linux-x64-musl
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            build-name: linux-arm64-gnu
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            build-name: linux-arm64-musl
          
          # Windows builds
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            build-name: win32-x64-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            build-name: win32-arm64-msvc

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: ${{ matrix.target }}

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        key: ${{ matrix.target }}

    - name: Install Node.js dependencies
      run: npm ci
      working-directory: ./specado-node

    - name: Build native module (Unix)
      if: runner.os != 'Windows'
      run: npm run build -- --target ${{ matrix.target }}
      working-directory: ./specado-node
      env:
        NAPI_RS_TARGET: ${{ matrix.target }}

    - name: Build native module (Windows)
      if: runner.os == 'Windows'
      run: npm run build -- --target ${{ matrix.target }}
      working-directory: ./specado-node
      env:
        NAPI_RS_TARGET: ${{ matrix.target }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: native-${{ matrix.build-name }}
        path: specado-node/*.node
        if-no-files-found: error

  test-native:
    name: Test native modules on ${{ matrix.os }}
    needs: build-native
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: ['16', '18', '20']

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install Node.js dependencies
      run: npm ci
      working-directory: ./specado-node

    - name: Download native artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Copy native modules
      run: |
        find artifacts/ -name "*.node" -exec cp {} specado-node/ \;
      shell: bash

    - name: Run tests
      run: npm test
      working-directory: ./specado-node

    - name: Test package functionality
      run: node scripts/verify-build.js
      working-directory: ./specado-node

  build-package:
    name: Build npm package
    needs: [build-native, test-native]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'

    - name: Install dependencies
      run: npm ci
      working-directory: ./specado-node

    - name: Download all native artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Copy native modules to package
      run: |
        find artifacts/ -name "*.node" -exec cp {} specado-node/ \;

    - name: List native modules
      run: ls -la *.node
      working-directory: ./specado-node

    - name: Build npm package
      run: npm pack
      working-directory: ./specado-node

    - name: Upload package
      uses: actions/upload-artifact@v4
      with:
        name: npm-package
        path: specado-node/*.tgz

  security-scan:
    name: Security scan
    needs: build-package
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: npm-package
        path: ./

    - name: Install security tools
      run: |
        npm install -g npm-audit-resolver audit-ci
        npm install -g @npmcli/package-json

    - name: Audit package dependencies
      run: |
        cd specado-node
        npm audit --audit-level high
      continue-on-error: true

    - name: Scan package with audit-ci
      run: |
        cd specado-node
        audit-ci --config .audit-ci.json
      continue-on-error: true

    - name: Validate package structure
      run: |
        TARBALL=$(ls *.tgz | head -1)
        echo "Validating package: $TARBALL"
        
        # Extract and verify structure
        tar -tzf "$TARBALL" | head -20
        
        # Check for required files
        tar -tzf "$TARBALL" | grep -E "(package\.json|index\.js|index\.d\.ts|README\.md)" || {
          echo "Missing required files in package"
          exit 1
        }

  publish:
    name: Publish to npm
    needs: [build-package, security-scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    environment:
      name: npm
      url: https://www.npmjs.com/package/@specado/core

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'

    - name: Download package
      uses: actions/download-artifact@v4
      with:
        name: npm-package
        path: ./

    - name: Extract package
      run: |
        TARBALL=$(ls *.tgz | head -1)
        echo "Publishing package: $TARBALL"
        tar -xzf "$TARBALL"
        PACKAGE_DIR=$(tar -tzf "$TARBALL" | head -1 | cut -d/ -f1)
        echo "PACKAGE_DIR=$PACKAGE_DIR" >> $GITHUB_ENV

    - name: Publish to Test npm
      if: github.event.inputs.test_npm == 'true'
      run: |
        cd "$PACKAGE_DIR"
        npm publish --registry https://registry.npmjs.org/ --tag alpha
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Publish to npm
      if: github.event.inputs.test_npm != 'true'
      run: |
        cd "$PACKAGE_DIR"
        npm publish --registry https://registry.npmjs.org/
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: Create GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.tgz
        body: |
          ## @specado/core ${{ github.ref_name }}
          
          High-performance Node.js bindings for Specado with automatic fallback routing and provider transformations.
          
          ### Installation
          ```bash
          npm install @specado/core@${{ github.ref_name }}
          ```
          
          ### What's Changed
          See [CHANGELOG.md](https://github.com/specado/specado/blob/main/specado-node/CHANGELOG.md) for detailed changes.
          
          ### Platform Support
          - Node.js 16.0.0+
          - macOS (Intel/Apple Silicon), Linux (x64/ARM64), Windows (x64/ARM64)
          - npm, yarn, pnpm package managers
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-publish:
    name: Post-publish tasks
    needs: publish
    runs-on: ubuntu-latest
    if: github.event_name == 'release'

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Check package availability
      run: |
        echo "Waiting for package to be available on npm..."
        for i in {1..30}; do
          if npm view @specado/core@${{ github.ref_name }} > /dev/null 2>&1; then
            echo "✅ Package is available on npm"
            break
          fi
          echo "⏳ Attempt $i/30: Package not yet available, waiting..."
          sleep 10
        done

    - name: Notify success
      run: |
        echo "🎉 Successfully published @specado/core@${{ github.ref_name }} to npm!"
        echo "📦 Package URL: https://www.npmjs.com/package/@specado/core"
        echo "📖 Documentation: https://github.com/specado/specado/tree/main/specado-node"